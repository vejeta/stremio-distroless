name: Cleanup Old Container Images

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      dry_run:
        description: 'Dry run mode - preview what would be deleted without actually deleting'
        required: false
        type: boolean
        default: false

permissions:
  packages: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show run configuration
        run: |
          echo "=== Cleanup Configuration ==="
          echo "Event: ${{ github.event_name }}"
          echo "Dry run: ${{ github.event.inputs.dry_run }}"
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "Mode: SCHEDULED RUN - Will delete old versions"
          elif [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "Mode: DRY RUN - Preview only, no deletions"
          else
            echo "Mode: MANUAL RUN - Will delete old versions"
          fi
          echo "============================"

      - name: Delete untagged image versions
        if: ${{ github.event_name == 'schedule' || github.event.inputs.dry_run != 'true' }}
        uses: actions/delete-package-versions@v5
        with:
          package-name: 'stremio-distroless'
          package-type: 'container'
          min-versions-to-keep: 0
          delete-only-untagged-versions: true
        continue-on-error: true

      - name: Get all package versions
        id: get-versions
        run: |
          echo "Fetching all package versions..."
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /users/${{ github.repository_owner }}/packages/container/stremio-distroless/versions \
            --paginate > versions.json

          echo "Total versions found: $(jq '. | length' versions.json)"

          # Extract versions to delete (keep only full semantic version tags and latest)
          jq -r '
            .[] |
            select(
              # Keep only FULL semantic version tags (x.y.z format, no x.y)
              # Pattern: wolfi-1.0.0-gui, debian-2.1.3-server (with optional v prefix)
              (.metadata.container.tags // [] |
               any(test("^(wolfi|debian)-(v?[0-9]+\\.[0-9]+\\.[0-9]+)-(gui|server)$")) | not) and
              # Keep versions with "latest" tag (wolfi-latest-gui, debian-latest-server)
              (.metadata.container.tags // [] |
               any(test("^(wolfi|debian)-latest-(gui|server)$")) | not)
            ) |
            .id
          ' versions.json > versions_to_delete.txt

          echo "Versions to delete: $(wc -l < versions_to_delete.txt)"

          # Show what will be deleted (for logging)
          echo "Preview of versions to delete:"
          jq -r '
            [
              .[] |
              select(
                (.metadata.container.tags // [] |
                 any(test("^(wolfi|debian)-(v?[0-9]+\\.[0-9]+\\.[0-9]+)-(gui|server)$")) | not) and
                (.metadata.container.tags // [] |
                 any(test("^(wolfi|debian)-latest-(gui|server)$")) | not)
              ) |
              "ID: \(.id) | Tags: \(.metadata.container.tags // [] | join(", "))"
            ] | limit(20; .[])
          ' versions.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete non-release versions
        if: ${{ github.event_name == 'schedule' || github.event.inputs.dry_run != 'true' }}
        run: |
          echo "=== Starting deletion process ==="

          if [ ! -s versions_to_delete.txt ]; then
            echo "No versions to delete"
            exit 0
          fi

          total_to_delete=$(wc -l < versions_to_delete.txt)
          echo "Found $total_to_delete versions to delete"

          deleted_count=0
          failed_count=0
          current=0

          while read -r version_id; do
            ((current++))
            echo "[$current/$total_to_delete] Deleting version ID: $version_id"

            if error_output=$(gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/users/${{ github.repository_owner }}/packages/container/stremio-distroless/versions/$version_id" \
              2>&1); then
              ((deleted_count++))
              echo "  ✓ Successfully deleted version $version_id"
            else
              ((failed_count++))
              echo "  ✗ Failed to delete version $version_id"
              echo "  Error: $error_output"
            fi

            # Rate limiting: small delay between deletions
            sleep 0.5
          done < versions_to_delete.txt

          echo ""
          echo "=== Deletion Summary ==="
          echo "  Total versions processed: $total_to_delete"
          echo "  Successfully deleted: $deleted_count"
          echo "  Failed: $failed_count"
          echo "======================="

          # Exit with error if any deletions failed
          if [ $failed_count -gt 0 ]; then
            echo "WARNING: Some deletions failed. Please review the logs above."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dry run summary
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
        run: |
          echo "=========================================="
          echo "         DRY RUN MODE - NO DELETIONS      "
          echo "=========================================="
          echo ""

          total_count=$(wc -l < versions_to_delete.txt)
          echo "Would delete $total_count version(s)"
          echo ""
          echo "To actually delete these versions:"
          echo "  1. Run this workflow manually"
          echo "  2. Set dry_run to 'false' or leave it unchecked"
          echo ""
          echo "=========================================="

      - name: Cleanup summary
        run: |
          echo ""
          echo "=========================================="
          echo "         CLEANUP JOB COMPLETED            "
          echo "=========================================="
          echo ""

          kept_versions=$(jq -r '
            [
              .[] |
              select(
                (.metadata.container.tags // [] |
                 any(test("^(wolfi|debian)-(v?[0-9]+\\.[0-9]+\\.[0-9]+)-(gui|server)$"))) or
                (.metadata.container.tags // [] |
                 any(test("^(wolfi|debian)-latest-(gui|server)$")))
              )
            ] | length
          ' versions.json)

          echo "Kept versions: $kept_versions"
          echo ""
          echo "These versions are kept (full semantic releases x.y.z and latest tags):"
          jq -r '
            .[] |
            select(
              (.metadata.container.tags // [] |
               any(test("^(wolfi|debian)-(v?[0-9]+\\.[0-9]+\\.[0-9]+)-(gui|server)$"))) or
              (.metadata.container.tags // [] |
               any(test("^(wolfi|debian)-latest-(gui|server)$")))
            ) |
            "  - \(.metadata.container.tags // [] | join(", "))"
          ' versions.json | sort -u
          echo ""
          echo "=========================================="
