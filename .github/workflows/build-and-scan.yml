name: Build and Security Scan - Multi-Ecosystem

# NOTE: Publishing to ghcr.io is DISABLED until testing is complete
# To enable publishing, change 'push: false' to 'push: ${{ github.event_name != 'pull_request' }}'

on:
  push:
    branches:
      - main
      - develop
      - 'claude/**'
    tags:
      - 'v*'
  # pull_request trigger disabled during development to avoid duplicate builds
  # Re-enable for production PR validation
  # pull_request:
  #   branches:
  #     - main
  workflow_dispatch:
  schedule:
    # Weekly security scans even without code changes
    - cron: '0 0 * * 0'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_BASE: ${{ github.repository }}

jobs:
  build-and-scan:
    name: Build ${{ matrix.ecosystem }}-${{ matrix.variant }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write  # For uploading SARIF to GitHub Security

    strategy:
      fail-fast: false
      matrix:
        ecosystem: [wolfi, debian]
        variant: [gui, server]
        include:
          - ecosystem: wolfi
            base_image: "Chainguard Wolfi"
            dockerfile_dir: wolfi
          - ecosystem: debian
            base_image: "Debian Trixie"
            dockerfile_dir: debian
          - variant: gui
            dockerfile: Dockerfile
            platforms: linux/amd64
            # Multi-arch disabled for testing: linux/amd64,linux/arm64
          - variant: server
            dockerfile: Dockerfile.server
            platforms: linux/amd64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login commented out until testing is complete
      # - name: Log in to Container Registry
      #   if: github.event_name != 'pull_request'
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ${{ env.REGISTRY }}
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BASE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
          flavor: |
            prefix=${{ matrix.ecosystem }}-
            suffix=-${{ matrix.variant }}

      - name: Build Docker image (testing only - no push)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile_dir }}/${{ matrix.dockerfile }}
          platforms: ${{ matrix.platforms }}
          push: false  # DISABLED: Set to true after testing
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.ecosystem }}-${{ matrix.variant }}
          cache-to: type=gha,mode=max,scope=${{ matrix.ecosystem }}-${{ matrix.variant }}
          load: true
          outputs: type=docker,dest=/tmp/${{ matrix.ecosystem }}-${{ matrix.variant }}.tar

      - name: Load image for scanning
        id: load-image
        continue-on-error: true
        run: |
          docker load --input /tmp/${{ matrix.ecosystem }}-${{ matrix.variant }}.tar
          echo "IMAGE_TAG=$(docker images --format '{{.Repository}}:{{.Tag}}' | head -n1)" >> $GITHUB_ENV

      # ==================== SBOM Generation ====================

      - name: Generate SBOM with Syft
        id: sbom
        uses: anchore/sbom-action@v0
        continue-on-error: true
        if: steps.load-image.outcome == 'success'
        with:
          image: ${{ env.IMAGE_TAG }}
          artifact-name: sbom-${{ matrix.ecosystem }}-${{ matrix.variant }}.spdx.json
          output-file: ./sbom-${{ matrix.ecosystem }}-${{ matrix.variant }}.spdx.json
          format: spdx-json

      - name: Upload SBOM as artifact
        uses: actions/upload-artifact@v4
        if: steps.sbom.outcome == 'success'
        with:
          name: sbom-${{ matrix.ecosystem }}-${{ matrix.variant }}
          path: ./sbom-${{ matrix.ecosystem }}-${{ matrix.variant }}.spdx.json
          retention-days: 90

      # ==================== Security Scanning: Trivy ====================

      - name: Run Trivy vulnerability scanner
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          image-ref: ${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-results-${{ matrix.ecosystem }}-${{ matrix.variant }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          scanners: 'vuln,secret,config'
          timeout: '15m'
          version: 'v0.67.2'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: success() || (failure() && steps.trivy.outcome == 'success')
        with:
          sarif_file: 'trivy-results-${{ matrix.ecosystem }}-${{ matrix.variant }}.sarif'
          category: trivy-${{ matrix.ecosystem }}-${{ matrix.variant }}

      - name: Generate Trivy JSON report
        id: trivy-json
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          image-ref: ${{ env.IMAGE_TAG }}
          format: 'json'
          output: 'trivy-results-${{ matrix.ecosystem }}-${{ matrix.variant }}.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'
          version: 'v0.67.2'

      - name: Upload Trivy JSON report
        uses: actions/upload-artifact@v4
        if: steps.trivy-json.outcome == 'success'
        with:
          name: trivy-report-${{ matrix.ecosystem }}-${{ matrix.variant }}
          path: trivy-results-${{ matrix.ecosystem }}-${{ matrix.variant }}.json
          retention-days: 30

      # ==================== Security Scanning: Grype ====================

      - name: Run Grype vulnerability scanner (Chainguard)
        uses: anchore/scan-action@v3
        id: grype
        continue-on-error: true
        with:
          image: ${{ env.IMAGE_TAG }}
          fail-build: false
          severity-cutoff: critical
          output-format: sarif

      - name: Upload Grype results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: success() || (failure() && steps.grype.outcome == 'success')
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}
          category: grype-${{ matrix.ecosystem }}-${{ matrix.variant }}

      - name: Generate Grype JSON report
        id: grype-json
        continue-on-error: true
        run: |
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            anchore/grype:latest \
            ${{ env.IMAGE_TAG }} \
            -o json \
            > grype-results-${{ matrix.ecosystem }}-${{ matrix.variant }}.json

      - name: Upload Grype JSON report
        uses: actions/upload-artifact@v4
        if: steps.grype-json.outcome == 'success'
        with:
          name: grype-report-${{ matrix.ecosystem }}-${{ matrix.variant }}
          path: grype-results-${{ matrix.ecosystem }}-${{ matrix.variant }}.json
          retention-days: 30

      # ==================== Security Hardening Verification ====================

      - name: Test container security posture
        run: |
          echo "::group::Security Posture Test"

          # Test 1: Verify nonroot user
          USER_ID=$(docker run --rm ${{ env.IMAGE_TAG }} id -u || echo "FAIL")
          if [ "$USER_ID" == "65532" ]; then
            echo "✓ Running as nonroot user (UID 65532)"
          else
            echo "✗ NOT running as nonroot user (UID: $USER_ID)"
            exit 1
          fi

          # Test 2: Verify no shell
          SHELL_CHECK=$(docker run --rm ${{ env.IMAGE_TAG }} /bin/sh -c "echo test" 2>&1 || echo "NO_SHELL")
          if echo "$SHELL_CHECK" | grep -q "NO_SHELL\|not found\|no such file"; then
            echo "✓ No shell present in image (distroless)"
          else
            echo "⚠ Shell may be present"
          fi

          # Test 3: Verify no package manager
          PKG_CHECK=$(docker run --rm ${{ env.IMAGE_TAG }} apk --version 2>&1 || echo "NO_APK")
          if echo "$PKG_CHECK" | grep -q "NO_APK\|not found\|no such file"; then
            echo "✓ No package manager present"
          else
            echo "⚠ Package manager may be present"
          fi

          # Test 4: Read-only root filesystem test
          echo "Testing read-only filesystem..."
          docker run --rm --read-only ${{ env.IMAGE_TAG }} ls / > /dev/null && echo "✓ Can run with read-only root" || echo "⚠ Read-only test inconclusive"

          echo "::endgroup::"

      # ==================== Image Size Analysis ====================

      - name: Analyze image size
        run: |
          echo "::group::Image Size Analysis"
          docker images ${{ env.IMAGE_TAG }} --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

          # Get size in MB
          SIZE=$(docker images ${{ env.IMAGE_TAG }} --format "{{.Size}}")
          echo "Image Size: $SIZE"
          echo "IMAGE_SIZE=$SIZE" >> $GITHUB_ENV
          echo "::endgroup::"

      # ==================== Generate Security Summary ====================

      - name: Generate security summary
        if: always()
        run: |
          cat << EOF > security-summary-${{ matrix.ecosystem }}-${{ matrix.variant }}.md
          # Security Scan Summary: ${{ matrix.ecosystem }}-${{ matrix.variant }}

          **Image**: \`${{ env.IMAGE_TAG }}\`
          **Base**: ${{ matrix.base_image }}
          **Size**: ${{ env.IMAGE_SIZE }}
          **Build Date**: $(date -u +"%Y-%m-%dT%H:%M:%SZ")

          ## Security Features

          - ✓ Distroless runtime (no shell, no package manager)
          - ✓ Nonroot user (UID 65532)
          - ✓ Multi-stage build (build tools not in final image)
          - ✓ SBOM generated (SPDX format)
          - ✓ CVE scanned (Trivy + Grype)

          ## Scan Results

          See attached artifacts for detailed reports:
          - **SBOM**: sbom-${{ matrix.ecosystem }}-${{ matrix.variant }}.spdx.json
          - **Trivy**: trivy-report-${{ matrix.ecosystem }}-${{ matrix.variant }}.json
          - **Grype**: grype-report-${{ matrix.ecosystem }}-${{ matrix.variant }}.json

          ## GitHub Security Tab

          SARIF results uploaded to Security tab for:
          - Trivy vulnerability scan
          - Grype vulnerability scan
          EOF

          cat security-summary-${{ matrix.ecosystem }}-${{ matrix.variant }}.md

      - name: Upload security summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-summary-${{ matrix.ecosystem }}-${{ matrix.variant }}
          path: security-summary-${{ matrix.ecosystem }}-${{ matrix.variant }}.md
          retention-days: 90

  # ==================== Comparison Report ====================

  compare-ecosystems:
    name: Compare Security Across Ecosystems
    runs-on: ubuntu-latest
    needs: build-and-scan
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Generate comparison report
        run: |
          cat << 'EOF' > ecosystem-comparison.md
          # Multi-Ecosystem Security Comparison

          This report compares security posture across Wolfi and Debian implementations.

          ## Methodology

          Both ecosystems implement identical security principles:
          - Distroless runtime (no shell, no package manager)
          - Zero Linux capabilities + group-based hardware access
          - Nonroot execution (UID 65532)
          - Read-only filesystem
          - Multi-stage builds

          ## Package Sources

          | Ecosystem | Package Source | Maintainer |
          |-----------|----------------|------------|
          | **Wolfi** | https://sourceforge.net/projects/wolfi/files/x86_64/ | vejeta (unofficial) |
          | **Debian** | https://debian.vejeta.com | vejeta (submitted to Debian mentors) |

          ## Scan Results Summary

          See individual artifact folders for detailed scans:
          - `trivy-report-*` - Trivy JSON vulnerability reports
          - `grype-report-*` - Grype JSON vulnerability reports
          - `sbom-*` - SPDX Software Bill of Materials

          ## Demonstrated Skills

          This multi-ecosystem approach demonstrates:

          1. **Cross-Ecosystem Expertise**: Proficiency in both APK (Wolfi) and DEB (Debian) packaging
          2. **Security Principle Mastery**: Same security posture regardless of base distribution
          3. **Supply Chain Security**: SBOM generation, CVE tracking, reproducible builds
          4. **DevSecOps Integration**: Automated security scanning in CI/CD pipeline
          5. **Package Maintenance**: Active maintenance of both APK and DEB repositories

          ## References

          - Wolfi packages: https://github.com/vejeta/wolfi-packages
          - Debian packages: https://debian.vejeta.com
          - Chainguard best practices: https://edu.chainguard.dev/
          - Debian security: https://www.debian.org/security/
          EOF

          cat ecosystem-comparison.md

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: ecosystem-comparison
          path: ecosystem-comparison.md
          retention-days: 90
